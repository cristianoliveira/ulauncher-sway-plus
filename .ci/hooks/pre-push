#!/usr/bin/env bash
set -euo pipefail

echo "ğŸ” Checking for pushable changes..."

# Determine the range of commits being pushed
remote="$1"
url="$2"
read local_ref local_sha remote_ref remote_sha

# Only push if there are changes
if [ "$local_sha" = "$remote_sha" ]; then
  echo "âœ… Nothing to push (no changes). Skipping checks."
  exit 0
fi

echo "ğŸ” Running checks before push..."

# Run linter
echo "ğŸ“¦ Running linter..."
if ! make lint; then
  echo "âŒ Lint failed. Fix issues before pushing."
  exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
if ! make test; then
  echo "âŒ Tests failed. Fix issues before pushing."
  exit 1
fi

# Check for WIP commits in push range
echo "ğŸ” Checking for WIP commits..."
if git log "$remote_sha..$local_sha" --oneline | grep -i 'WIP'; then
  echo "âŒ Push blocked: WIP commits found in push range."
  exit 1
fi

echo "âœ… All checks passed. Ready to push!"
exit 0
